{% extends 'backoffice/base.html' %}

{% block title %}Analytics - Banbas Resort Management{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="fas fa-chart-bar text-primary me-2"></i>
        Analytics Dashboard
    </h1>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'backoffice:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item active">Analytics</li>
        </ol>
    </nav>
</div>

<!-- Date Filter -->
<div class="stat-card mb-4">
    <form method="get" class="row g-3 align-items-end">
        <div class="col-md-3">
            <label for="date_from" class="form-label">From Date</label>
            <input type="date" class="form-control" id="date_from" name="date_from" 
                   value="{{ date_from|date:'Y-m-d' }}">
        </div>
        <div class="col-md-3">
            <label for="date_to" class="form-label">To Date</label>
            <input type="date" class="form-control" id="date_to" name="date_to" 
                   value="{{ date_to|date:'Y-m-d' }}">
        </div>
        <div class="col-md-3">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-filter me-2"></i>
                Update Report
            </button>
        </div>
        <div class="col-md-3 text-end">
            <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                Showing data from {{ date_from|date:"M d, Y" }} to {{ date_to|date:"M d, Y" }}
            </small>
        </div>
    </form>
</div>

<!-- Key Metrics -->
<div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="stat-card text-center">
            <div class="stat-icon bg-primary bg-opacity-10 text-primary mx-auto">
                <i class="fas fa-calendar-check"></i>
            </div>
            <h3 class="fw-bold text-primary">{{ total_reservations }}</h3>
            <p class="text-muted mb-0">Total Reservations</p>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="stat-card text-center">
            <div class="stat-icon bg-success bg-opacity-10 text-success mx-auto">
                <i class="fas fa-bed"></i>
            </div>
            <h3 class="fw-bold text-success">{{ occupancy_data.total_rooms|default:0 }}</h3>
            <p class="text-muted mb-0">Rooms Booked</p>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="stat-card text-center">
            <div class="stat-icon bg-info bg-opacity-10 text-info mx-auto">
                <i class="fas fa-users"></i>
            </div>
            <h3 class="fw-bold text-info">
                {{ total_guests.adults|default:0 }}
                {% if total_guests.children %}
                    <small class="text-muted">+ {{ total_guests.children }} child{{ total_guests.children|pluralize:"ren" }}</small>
                {% endif %}
            </h3>
            <p class="text-muted mb-0">Total Guests</p>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="stat-card text-center">
            <div class="stat-icon bg-warning bg-opacity-10 text-warning mx-auto">
                <i class="fas fa-envelope"></i>
            </div>
            <h3 class="fw-bold text-warning">{{ inquiries_count }}</h3>
            <p class="text-muted mb-0">New Inquiries</p>
        </div>
    </div>
</div>

<!-- Revenue Section (Admin Only) -->
{% if user.userprofile.can_view_revenue and revenue_data %}
<div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="stat-card text-center">
            <div class="stat-icon bg-success bg-opacity-10 text-success mx-auto">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <h3 class="fw-bold text-success">
                ${{ revenue_data.total_revenue|default:0|floatformat:2 }}
            </h3>
            <p class="text-muted mb-0">Total Revenue</p>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="stat-card text-center">
            <div class="stat-icon bg-primary bg-opacity-10 text-primary mx-auto">
                <i class="fas fa-chart-line"></i>
            </div>
            <h3 class="fw-bold text-primary">
                {% if total_reservations > 0 and revenue_data.total_revenue %}
                    {% widthratio revenue_data.total_revenue 1 1 as total_revenue_int %}
                    {% widthratio total_revenue_int total_reservations 1 as avg_revenue %}
                    ${{ avg_revenue|floatformat:2 }}
                {% else %}
                    $0.00
                {% endif %}
            </h3>
            <p class="text-muted mb-0">Average per Reservation</p>
        </div>
    </div>
</div>
{% endif %}

<!-- Detailed Analytics -->
<div class="row g-4">
    <!-- Room Analytics -->
    <div class="col-lg-6">
        <div class="stat-card">
            <h5 class="fw-semibold mb-3">
                <i class="fas fa-bed text-info me-2"></i>
                Accommodation Overview
            </h5>
            
            <div class="row g-3 mb-3">
                <div class="col-sm-6">
                    <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                        <span class="text-muted">Total Reservations:</span>
                        <span class="fw-semibold">{{ total_reservations }}</span>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                        <span class="text-muted">Rooms Booked:</span>
                        <span class="fw-semibold">{{ occupancy_data.total_rooms|default:0 }}</span>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                        <span class="text-muted">Adult Guests:</span>
                        <span class="fw-semibold">{{ total_guests.adults|default:0 }}</span>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                        <span class="text-muted">Child Guests:</span>
                        <span class="fw-semibold">{{ total_guests.children|default:0 }}</span>
                    </div>
                </div>
            </div>
            
            {% if total_reservations > 0 %}
                <div class="mt-3">
                    <small class="text-success">
                        <i class="fas fa-chart-line me-1"></i>
                        {% if total_reservations > 0 %}
                            {% widthratio occupancy_data.total_rooms|default:0 total_reservations 1 as avg_rooms %}
                            Average {{ avg_rooms|floatformat:1 }} rooms per reservation
                        {% else %}
                            No reservations in period
                        {% endif %}
                    </small>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Guest Analytics -->
    <div class="col-lg-6">
        <div class="stat-card">
            <h5 class="fw-semibold mb-3">
                <i class="fas fa-envelope text-warning me-2"></i>
                Inquiry Overview
            </h5>
            
            <div class="row g-3 mb-3">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center p-3 bg-warning bg-opacity-10 rounded">
                        <div>
                            <span class="text-muted">Total Inquiries</span>
                            <div class="fw-bold text-warning">{{ inquiries_count }}</div>
                        </div>
                        <div class="text-end">
                            <i class="fas fa-envelope fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
                
                {% if inquiries_count > 0 %}
                <div class="col-12">
                    <div class="progress">
                        {% if total_reservations > 0 and inquiries_count > 0 %}
                            {% widthratio total_reservations inquiries_count 100 as conversion_percent %}
                            <div class="progress-bar bg-warning" role="progressbar" 
                                 style="width: {{ conversion_percent|floatformat:0 }}%" 
                                 aria-valuenow="{{ total_reservations }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="{{ inquiries_count }}">
                            </div>
                        {% else %}
                            <div class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                        {% endif %}
                    </div>
                    <small class="text-muted mt-1 d-block">
                        {% if inquiries_count > 0 and total_reservations > 0 %}
                            {% widthratio total_reservations inquiries_count 100 as conversion_rate %}
                            Conversion Rate: {{ conversion_rate|floatformat:1 }}%
                        {% else %}
                            No conversion data available
                        {% endif %}
                    </small>
                </div>
                {% endif %}
            </div>
            
            <div class="text-center">
                <a href="{% url 'backoffice:inquiry_list' %}" class="btn btn-outline-warning btn-sm">
                    <i class="fas fa-envelope me-2"></i>
                    View All Inquiries
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Additional Insights -->
{% if total_reservations > 0 %}
<div class="row g-4 mt-2">
    <div class="col-12">
        <div class="stat-card">
            <h5 class="fw-semibold mb-3">
                <i class="fas fa-lightbulb text-success me-2"></i>
                Key Insights
            </h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="insight-card p-3 border-start border-success border-3">
                        <h6 class="text-success">Guest Capacity</h6>
                        <p class="mb-0">
                            {% if total_reservations > 0 %}
                                {% widthratio total_guests.adults|default:0 total_reservations 1 as avg_adults %}
                                Average of <strong>{{ avg_adults|floatformat:1 }}</strong> adults per reservation
                            {% else %}
                                No reservations to calculate average
                            {% endif %}
                        </p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="insight-card p-3 border-start border-info border-3">
                        <h6 class="text-info">Room Utilization</h6>
                        <p class="mb-0">
                            <strong>{{ occupancy_data.total_rooms|default:0 }}</strong> rooms booked 
                            across {{ total_reservations }} reservations
                        </p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="insight-card p-3 border-start border-warning border-3">
                        <h6 class="text-warning">Period Performance</h6>
                        <p class="mb-0">
                            <strong>{{ total_reservations }}</strong> reservations in selected period
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- No Data Message -->
{% if total_reservations == 0 %}
<div class="row mt-4">
    <div class="col-12">
        <div class="stat-card text-center py-5">
            <i class="fas fa-chart-bar fa-4x text-muted mb-4"></i>
            <h4 class="text-muted mb-3">No Data Available</h4>
            <p class="text-muted mb-4">
                There are no reservations in the selected date range. 
                Try adjusting your date filters or create some reservations to see analytics.
            </p>
            <a href="{% url 'backoffice:reservation_create' %}" class="btn btn-primary me-2">
                <i class="fas fa-plus me-2"></i>
                Create Reservation
            </a>
            <a href="{% url 'backoffice:reservation_list' %}" class="btn btn-outline-primary">
                <i class="fas fa-list me-2"></i>
                View All Reservations
            </a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Set default date range to last 30 days if not specified
document.addEventListener('DOMContentLoaded', function() {
    const dateFromInput = document.getElementById('date_from');
    const dateToInput = document.getElementById('date_to');
    
    if (!dateFromInput.value) {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        dateFromInput.value = thirtyDaysAgo.toISOString().split('T')[0];
    }
    
    if (!dateToInput.value) {
        const today = new Date();
        dateToInput.value = today.toISOString().split('T')[0];
    }
});
</script>
{% endblock %}