{% extends 'backoffice/base.html' %}

{% block title %}
    {% if object %}Edit Reservation{% else %}New Reservation{% endif %} - Banbas Resort Management
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        {% if object %}
            <i class="fas fa-edit text-warning me-2"></i>
            Edit Reservation
        {% else %}
            <i class="fas fa-plus-circle text-primary me-2"></i>
            New Reservation
        {% endif %}
    </h1>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'backoffice:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'backoffice:reservation_list' %}">Reservations</a></li>
            <li class="breadcrumb-item active">
                {% if object %}Edit{% else %}New{% endif %}
            </li>
        </ol>
    </nav>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="stat-card">
            <form method="post" id="reservationForm">
                {% csrf_token %}
                
                <!-- Form Errors -->
                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        <strong>Please fix the following errors:</strong>
                        <ul class="mb-0 mt-2">
                            {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                <!-- Guest Information Section -->
                <div class="form-section mb-4">
                    <h5 class="section-title text-primary mb-3">
                        <i class="fas fa-user me-2"></i>Guest Information
                    </h5>
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label for="{{ form.guest_full_name.id_for_label }}" class="form-label">
                                Guest Full Name <span class="text-danger">*</span>
                            </label>
                            {{ form.guest_full_name }}
                            {% if form.guest_full_name.errors %}
                                <div class="text-danger small mt-1">{{ form.guest_full_name.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.nationality.id_for_label }}" class="form-label">
                                Nationality <span class="text-danger">*</span>
                            </label>
                            {{ form.nationality }}
                            {% if form.nationality.errors %}
                                <div class="text-danger small mt-1">{{ form.nationality.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-8">
                            <label for="{{ form.company_name.id_for_label }}" class="form-label">
                                Company Name <span class="text-muted">(Optional)</span>
                            </label>
                            {{ form.company_name }}
                            {% if form.company_name.errors %}
                                <div class="text-danger small mt-1">{{ form.company_name.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.contact_number.id_for_label }}" class="form-label">
                                Contact Number
                            </label>
                            {{ form.contact_number }}
                            {% if form.contact_number.errors %}
                                <div class="text-danger small mt-1">{{ form.contact_number.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Stay Details Section -->
                <div class="form-section mb-4">
                    <h5 class="section-title text-success mb-3">
                        <i class="fas fa-calendar-alt me-2"></i>Stay Details
                    </h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="{{ form.arrival_date.id_for_label }}" class="form-label">
                                Arrival Date <span class="text-danger">*</span>
                            </label>
                            {{ form.arrival_date }}
                            {% if form.arrival_date.errors %}
                                <div class="text-danger small mt-1">{{ form.arrival_date.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.departure_date.id_for_label }}" class="form-label">
                                Departure Date <span class="text-danger">*</span>
                            </label>
                            {{ form.departure_date }}
                            {% if form.departure_date.errors %}
                                <div class="text-danger small mt-1">{{ form.departure_date.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.total_adults.id_for_label }}" class="form-label">
                                Total Adults <span class="text-danger">*</span>
                            </label>
                            {{ form.total_adults }}
                            {% if form.total_adults.errors %}
                                <div class="text-danger small mt-1">{{ form.total_adults.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.total_children.id_for_label }}" class="form-label">
                                Total Children <span class="text-danger">*</span>
                            </label>
                            {{ form.total_children }}
                            {% if form.total_children.errors %}
                                <div class="text-danger small mt-1">{{ form.total_children.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Room Details Section -->
                <div class="form-section mb-4">
                    <h5 class="section-title text-info mb-3">
                        <i class="fas fa-bed me-2"></i>Room Details
                    </h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="{{ form.room_category.id_for_label }}" class="form-label">
                                Room Category <span class="text-danger">*</span>
                            </label>
                            {{ form.room_category }}
                            {% if form.room_category.errors %}
                                <div class="text-danger small mt-1">{{ form.room_category.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.number_of_rooms.id_for_label }}" class="form-label">
                                Total Rooms <span class="text-danger">*</span>
                            </label>
                            {{ form.number_of_rooms }}
                            {% if form.number_of_rooms.errors %}
                                <div class="text-danger small mt-1">{{ form.number_of_rooms.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Room Type Selection -->
                    <div class="mt-3">
                        <label class="form-label">Room Types & Quantities <span class="text-danger">*</span></label>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="border rounded p-3">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input room-type-check" type="checkbox" 
                                               id="single_check" data-target="single_rooms">
                                        <label class="form-check-label fw-semibold" for="single_check">
                                            Single Rooms
                                        </label>
                                    </div>
                                    <div class="input-group">
                                        <span class="input-group-text">Qty</span>
                                        {{ form.single_rooms }}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="border rounded p-3">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input room-type-check" type="checkbox" 
                                               id="double_check" data-target="double_rooms">
                                        <label class="form-check-label fw-semibold" for="double_check">
                                            Double Rooms
                                        </label>
                                    </div>
                                    <div class="input-group">
                                        <span class="input-group-text">Qty</span>
                                        {{ form.double_rooms }}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="border rounded p-3">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input room-type-check" type="checkbox" 
                                               id="triple_check" data-target="triple_rooms">
                                        <label class="form-check-label fw-semibold" for="triple_check">
                                            Triple Rooms
                                        </label>
                                    </div>
                                    <div class="input-group">
                                        <span class="input-group-text">Qty</span>
                                        {{ form.triple_rooms }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Meal Plan Section -->
                <div class="form-section mb-4">
                    <h5 class="section-title text-warning mb-3">
                        <i class="fas fa-utensils me-2"></i>Meal Plan
                    </h5>
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="{{ form.meal_plan.id_for_label }}" class="form-label">
                                Meal Plan <span class="text-danger">*</span>
                            </label>
                            {{ form.meal_plan }}
                            {% if form.meal_plan.errors %}
                                <div class="text-danger small mt-1">{{ form.meal_plan.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Payment Section -->
                <div class="form-section mb-4">
                    <h5 class="section-title text-success mb-3">
                        <i class="fas fa-money-bill-wave me-2"></i>Payment Details
                    </h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="{{ form.payment_method.id_for_label }}" class="form-label">
                                Payment Method <span class="text-danger">*</span>
                            </label>
                            {{ form.payment_method }}
                            {% if form.payment_method.errors %}
                                <div class="text-danger small mt-1">{{ form.payment_method.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.payment_currency.id_for_label }}" class="form-label">
                                Currency <span class="text-danger">*</span>
                            </label>
                            {{ form.payment_currency }}
                            {% if form.payment_currency.errors %}
                                <div class="text-danger small mt-1">{{ form.payment_currency.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-12">
                            <label for="{{ form.total_price.id_for_label }}" class="form-label">
                                Total Price <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-dollar-sign"></i>
                                </span>
                                {{ form.total_price }}
                            </div>
                            {% if form.total_price.errors %}
                                <div class="text-danger small mt-1">{{ form.total_price.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Booking Information Section -->
                <div class="form-section mb-4">
                    <h5 class="section-title text-secondary mb-3">
                        <i class="fas fa-user-tie me-2"></i>Booking Information
                    </h5>
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="{{ form.booked_by.id_for_label }}" class="form-label">
                                Booked By <span class="text-danger">*</span>
                            </label>
                            {{ form.booked_by }}
                            {% if form.booked_by.errors %}
                                <div class="text-danger small mt-1">{{ form.booked_by.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Submit Buttons -->
                <div class="d-flex gap-3 pt-3 border-top">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>
                        {% if object %}Update Reservation{% else %}Create Reservation{% endif %}
                    </button>
                    <a href="{% url 'backoffice:reservation_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-2"></i>
                        Cancel
                    </a>
                    {% if object %}
                        <a href="{% url 'backoffice:reservation_detail' object.pk %}" class="btn btn-outline-info">
                            <i class="fas fa-eye me-2"></i>
                            View Details
                        </a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
    
    <!-- Help Sidebar -->
    <div class="col-lg-4">
        <div class="stat-card">
            <h6 class="fw-semibold text-primary mb-3">
                <i class="fas fa-info-circle me-2"></i>
                Required Fields
            </h6>
            <ul class="list-unstyled small">
                <li class="mb-1"><i class="fas fa-check text-success me-2"></i>Guest Full Name</li>
                <li class="mb-1"><i class="fas fa-check text-success me-2"></i>Arrival & Departure Dates</li>
                <li class="mb-1"><i class="fas fa-check text-success me-2"></i>Nationality</li>
                <li class="mb-1"><i class="fas fa-check text-success me-2"></i>Room Category</li>
                <li class="mb-1"><i class="fas fa-check text-success me-2"></i>Room Types & Quantities</li>
                <li class="mb-1"><i class="fas fa-check text-success me-2"></i>Meal Plan</li>
                <li class="mb-1"><i class="fas fa-check text-success me-2"></i>Total Adults & Children</li>
                <li class="mb-1"><i class="fas fa-check text-success me-2"></i>Booked By</li>
                <li class="mb-1"><i class="fas fa-check text-success me-2"></i>Payment Method & Currency</li>
                <li class="mb-1"><i class="fas fa-check text-success me-2"></i>Total Price</li>
            </ul>
        </div>
        
        <div class="stat-card mt-3">
            <h6 class="fw-semibold text-info mb-3">
                <i class="fas fa-lightbulb me-2"></i>
                Tips
            </h6>
            <ul class="list-unstyled small text-muted">
                <li class="mb-2">• Select room types by checking boxes and entering quantities</li>
                <li class="mb-2">• Total rooms will auto-calculate from room type quantities</li>
                <li class="mb-2">• All dates must be in the future</li>
                <li class="mb-2">• Contact number is optional but recommended</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Room type checkbox handling
    const checkboxes = document.querySelectorAll('.room-type-check');
    const roomInputs = {
        'single_rooms': document.getElementById('id_single_rooms'),
        'double_rooms': document.getElementById('id_double_rooms'),
        'triple_rooms': document.getElementById('id_triple_rooms')
    };
    const totalRoomsInput = document.getElementById('id_number_of_rooms');
    
    // Initialize checkboxes based on current values
    Object.keys(roomInputs).forEach(key => {
        const input = roomInputs[key];
        const checkbox = document.querySelector(`[data-target="${key}"]`);
        if (input.value && parseInt(input.value) > 0) {
            checkbox.checked = true;
        }
        updateRoomInputState(checkbox, input);
    });
    
    // Add event listeners
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const targetId = this.dataset.target;
            const input = roomInputs[targetId];
            updateRoomInputState(this, input);
            updateTotalRooms();
        });
    });
    
    // Add input listeners for quantity changes
    Object.values(roomInputs).forEach(input => {
        input.addEventListener('input', updateTotalRooms);
    });
    
    function updateRoomInputState(checkbox, input) {
        if (checkbox.checked) {
            input.disabled = false;
            if (!input.value || input.value === '0') {
                input.value = '1';
            }
        } else {
            input.disabled = true;
            input.value = '0';
        }
    }
    
    function updateTotalRooms() {
        let total = 0;
        Object.values(roomInputs).forEach(input => {
            if (!input.disabled && input.value) {
                total += parseInt(input.value) || 0;
            }
        });
        totalRoomsInput.value = total;
    }
    
    // Initial calculation
    updateTotalRooms();
});
</script>
{% endblock %}